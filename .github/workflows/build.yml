name: Build Kivy APK (Docker Image)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

defaults:
  run:
    shell: bash

permissions:
  contents: read
  packages: read

jobs:
  build-android:
    runs-on: ubuntu-latest

    # استخدم صورتك الخاصة من GHCR
    container:
      image: ghcr.io/lamideag/buildozer:latest
      # يفضل لاحقاً استبدال :latest بـ digest لضمان ثبات الصورة

    env:
      APP_DIR: test_app
      APP_ANDROID_ACCEPT_SDK_LICENSE: 1
      BUILDOZER_WARN_ON_ROOT: 0
      ANDROID_HOME: /home/user/.buildozer/android/platform/android-sdk

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Cache buildozer & pip
        uses: actions/cache@v3
        with:
          path: |
            ~/.buildozer
            ~/.cache/pip
          key: buildozer-${{ runner.os }}-${{ hashFiles(env.APP_DIR + '/buildozer.spec') }}

      - name: Verify container (informational)
        run: |
          echo "Running inside container"
          buildozer --version || true
          which buildozer || true
          echo "whoami: $(whoami)"
          id || true
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "PATH=$PATH"

      - name: Check for sdkmanager (fail early with clear advice)
        run: |
          if ! command -v sdkmanager >/dev/null 2>&1; then
            echo "::warning::sdkmanager not found in image PATH. This image likely does NOT include Android cmdline-tools / SDK."
            echo "You have two options:"
            echo "  1) Rebuild your GHCR image to include Android cmdline-tools & build-tools (recommended)."
            echo "  2) Use a different image that has sdkmanager."
            echo "Failing the job to avoid hidden/partial installs."
            exit 1
          fi
          echo "sdkmanager found: $(command -v sdkmanager)"

      - name: Ensure Android SDK / build-tools and accept licenses (if sdkmanager present)
        run: |
          set -e
          export ANDROID_HOME="${ANDROID_HOME}"
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH"
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-36" "build-tools;36.1.0" || true

      - name: Build APK (non-interactive)
        working-directory: ${{ github.workspace }}/${{ env.APP_DIR }}
        run: |
          set -euo pipefail
          printf "y\n" | buildozer android debug --no-confirm

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: ${{ env.APP_DIR }}/bin/*.apk
