name: Build Android APK (Fix Cython + Cache)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-22.04
    env:
      WORKDIR: test_app
      APP_ANDROID_ACCEPT_SDK_LICENSE: "1"
      BUILDOZER_WARN_ON_ROOT: "0"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python & JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y python3-pip python3-dev build-essential git unzip zip ca-certificates openjdk-17-jdk-headless libssl-dev libffi-dev zlib1g-dev

      - name: Install Cython and Buildozer
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          sudo python3 -m pip install --upgrade cython==0.29.33 buildozer
          # Link cython3 to cython so Buildozer finds it
          sudo ln -sf /usr/bin/cython3 /usr/local/bin/cython
          which cython
          cython --version

      - name: Build APK
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          buildozer -v android debug --no-clean --log-level=2 2>&1 | tee full-buildozer.log
          rc=${PIPESTATUS[0]}
          cat full-buildozer.log
          exit $rc

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-log
          path: full-buildozer.log
