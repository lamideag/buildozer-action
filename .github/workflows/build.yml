name: Build Kivy APK (Docker Image)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  build-android:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/lamideag/buildozer:latest
      # لاحقًا يمكن استخدام digest لضمان نفس النسخة

    env:
      APP_DIR: test_app
      APP_ANDROID_ACCEPT_SDK_LICENSE: 1
      BUILDOZER_WARN_ON_ROOT: 0

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Verify container (important)
        run: |
          echo "Running inside image:"
          buildozer --version
          which buildozer
          whoami
          id

      - name: Build APK (as non-root user)
        working-directory: ${{ github.workspace }}/${{ env.APP_DIR }}
        run: |
          # جرب تشغيل buildozer كمستخدم موجود داخل الصورة
          if su user -s /bin/bash -c "buildozer --version >/dev/null 2>&1"; then
            su user -s /bin/bash -c "cd $GITHUB_WORKSPACE/${APP_DIR} && buildozer android debug --no-confirm"
          elif runuser -u user -- bash -lc "buildozer --version >/dev/null 2>&1"; then
            runuser -u user -- bash -lc "cd $GITHUB_WORKSPACE/${APP_DIR} && buildozer android debug --no-confirm"
          elif sudo -u user bash -lc "buildozer --version >/dev/null 2>&1"; then
            sudo -u user bash -lc "cd $GITHUB_WORKSPACE/${APP_DIR} && buildozer android debug --no-confirm"
          else
            echo "Fallback: buildozer will run as root (may fail)"
            printf 'y\n' | buildozer android debug --no-confirm

          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: ${{ env.APP_DIR }}/bin/*.apk






