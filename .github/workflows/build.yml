name: Build Android APK (Better persistent cache)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-22.04
    env:
      WORKDIR: test_app
      APP_ANDROID_ACCEPT_SDK_LICENSE: "1"
      BUILDOZER_WARN_ON_ROOT: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------- 1) GLOBAL cache (stable key) ----------
      - name: Restore global cache (SDK/NDK/Buildozer/Gradle/.local)
        id: cache-global
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            ~/.gradle
            ~/.local
          # مفتاح ثابت: غيّره يدوياً (v1->v2) عند رغبتك في إفراغ الكاش
          key: buildozer-global-v1-${{ runner.os }}
          restore-keys: |
            buildozer-global-v1-${{ runner.os }}-
            buildozer-global-${{ runner.os }}-

      # ---------- 2) per-spec cache (pip wheels etc.) ----------
      - name: Restore pip cache (per-spec)
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/buildozer.spec') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Print cache hit info and directories (debug)
        run: |
          echo "CACHE-GLOBAL-HIT=${{ steps.cache-global.outputs.cache-hit }}"
          echo "CACHE-PIP-HIT=${{ steps.cache-pip.outputs.cache-hit }}"
          echo "---- ~/.buildozer (trimmed listing) ----"
          if [ -d "$HOME/.buildozer" ]; then
            find "$HOME/.buildozer" -maxdepth 2 -type d -print | head -n 60 || true
            du -sh "$HOME/.buildozer" || true
          else
            echo "~/.buildozer missing"
          fi
          echo "---- ~/.gradle wrapper dists (first entries) ----"
          ls -la ~/.gradle/wrapper/dists || true
          du -sh ~/.gradle || true
          echo "---- ~/.local/bin (installed user binaries) ----"
          ls -la ~/.local/bin || true
          echo "---- End debug ----"

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install minimal system deps
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y --no-install-recommends \
            python3-pip python3-dev build-essential git unzip zip curl ca-certificates \
            openjdk-17-jdk-headless autoconf automake libtool m4 pkg-config \
            libssl-dev libffi-dev zlib1g-dev libbz2-dev liblzma-dev \
            libsqlite3-dev libncurses-dev
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install Cython & Buildozer (system-wide so Buildozer detects Cython)
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          sudo python3 -m pip install --upgrade "cython==0.29.33" buildozer

      - name: Verify cython & buildozer presence
        run: |
          echo "which cython: $(which cython || true)"
          cython --version || true
          echo "which buildozer: $(which buildozer || true)"
          buildozer --version || true

      - name: Ensure buildozer.spec has fixed Android versions (reduces downloads)
        run: |
          SPEC="${GITHUB_WORKSPACE}/${{ env.WORKDIR }}/buildozer.spec"
          if [ -f "$SPEC" ]; then
            # Remove any existing android.* lines to avoid duplicates
            sed -i '/^android.api/ d' "$SPEC" || true
            sed -i '/^android.minapi/ d' "$SPEC" || true
            sed -i '/^android.sdk/ d' "$SPEC" || true
            sed -i '/^android.ndk/ d' "$SPEC" || true
            sed -i '/^android.build_tools_version/ d' "$SPEC" || true
            # Append stable values (adjust these if you need different versions)
            printf '\n# Pinned by CI: stable android toolchain to reuse cache\nandroid.api = 31\nandroid.minapi = 21\nandroid.sdk = 33\nandroid.ndk = 25b\nandroid.build_tools_version = 33.0.2\n' >> "$SPEC"
            echo "Updated $SPEC with pinned android.api/android.sdk/android.ndk"
            tail -n 20 "$SPEC" || true
          else
            echo "No buildozer.spec found at $SPEC"
          fi

      - name: Print environment (basic)
        run: |
          echo "Which buildozer: $(which buildozer || true)"
          buildozer --version || true
          python3 --version
          java -version || true

      - name: Build (only build, reuse cache, no clean)
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          echo "Contents of ~/.buildozer before build:"
          ls -la ~/.buildozer || true
          du -sh ~/.buildozer || true

          # Use --no-clean to preserve and reuse p4a/NDK artifacts from cache
          buildozer -v android debug --no-clean --log-level=2 2>&1 | tee buildozer-output.log
          rc=${PIPESTATUS[0]}
          echo "BUILD_EXIT_CODE=$rc" >> $GITHUB_OUTPUT
          if [ "$rc" -ne 0 ]; then
            echo "Build failed. Tail:"
            tail -n 400 buildozer-output.log || true
            exit $rc
          fi

      - name: Find APKs
        id: find_apks
        run: |
          find . -type f \( -iname "*.apk" -o -iname "*.aab" \) -print > /tmp/apks.txt || true
          if [ -s /tmp/apks.txt ]; then
            echo "artifact_path=$(head -n 1 /tmp/apks.txt)" >> $GITHUB_OUTPUT
          fi

      - name: Upload logs & artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-artifacts
          path: |
            buildozer-output.log
            ~/.buildozer/**
            ~/.gradle/**
            **/*.apk
            **/*.aab
          if-no-files-found: warn
